<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="description" content="A fast, lightweight way to track CUMTD buses in Urbana-Champaign. Built with location tracking, recent stops, and more.">
  <script src="https://npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- JS file -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/easy-autocomplete/1.3.5/jquery.easy-autocomplete.min.js"></script>
  <script src="api-keys.js"></script>
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

  <!-- CSS file -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/easy-autocomplete/1.3.5/easy-autocomplete.min.css">

  <!-- Additional CSS Themes file - not required-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/easy-autocomplete/1.3.5/easy-autocomplete.themes.css">

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <style>
    .table td {
      padding-top: 2rem;
      padding-bottom: 2rem;
      font-size: 20px;
      border-top: none;
      font-family: 'Lato', sans-serif;
    }
  </style>
  <title>Live Bus Tracker</title>

  <!-- Bootstrap -->

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-109186351-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'UA-109186351-1');
  </script>
</head>

<body>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script>
    function setOptions() { //Does all the autocomplete setup.
      var options = {
        url: function(phrase) {
          return "https://www.cumtd.com/autocomplete/stops/v1.0/json/search?query=" + phrase + "&format=json";
        },

        getValue: "n",

        list: {

          onChooseEvent: function() {
            var id = $("#provider-remote").getSelectedItemData().i;
            var name = $("#provider-remote").getSelectedItemData().n;
            var storedAry = Cookies.get("storedAry");
            if (!storedAry) {
              storedAry = [];
            } else {
              storedAry = JSON.parse(storedAry);
            }
            storedAry.push([id, name]);
            Cookies.set("storedAry", storedAry, {
              path: '/',
              expires: 10
            });
            window.location = `BusTracking.html?id=${id}&name=${name}`
          }
        }
      };

      $("#provider-remote").easyAutocomplete(options);
    }

    function calcCrow(lat1, lon1, lat2, lon2) {
      var R = 6371; // km
      var dLat = toRad(lat2 - lat1);
      var dLon = toRad(lon2 - lon1);
      var lat1 = toRad(lat1);
      var lat2 = toRad(lat2);

      var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      var d = R * c;

      return d * 0.62137119; //to miles
    }

    // Converts numeric degrees to radians
    function toRad(Value) {
      return Value * Math.PI / 180;
    }
    var google_api = my_api_keys.GOOGLE_API_KEY;
    var cumtd_api = my_api_keys.CUMTD_API_KEY;
    var vars = {};
    var stop_lat = 0;
    var stop_long = 0;
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m, key, value) {
      vars[key] = value;
    });

    function getInfo() {
      document.body.innerHTML+=`
    <center>
    <div class="modal fade" id='myModal'>
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Where would you like to go?</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          </div>
          <div class="modal-body" id="modalBody2">
            <p>Modal body text goes here.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </center>`
      $.getJSON(`https://developer.cumtd.com/api/v2.2/json/getstop?key=${cumtd_api}&stop_id=` + vars["id"], function(data) {
        stop_lat = data.stops[0].stop_points[0].stop_lat;
        stop_long = data.stops[0].stop_points[0].stop_lon;
      });
      var count = 60;
      var interval = setInterval(function() {
        count--;
        if (count == 50) {
          ga('create', 'UA-109186351-1', 'auto');
          ga('set', 'dimension1', vars['id']);
          ga('set', 'dimension2', vars['name']);
          ga('send', 'HIT');
          ga('send', 'event', 'Stayed on page', vars['name']);
        }
        document.getElementById("change").innerHTML = `<h4>Refreshing in ${count}s</h4><br/><h6>The current time is ${new Date().toLocaleTimeString()}</h6>`;
      }, 1000);
      //set cookies
      //var myAry = [1, 2, 3];
      //Cookies.set('name', JSON.stringify(myAry));
      //var storedAry = JSON.parse(Cookies.get('name'));
      $.getJSON(`https://developer.cumtd.com/api/v2.2/json/getdeparturesbystop?key=${cumtd_api}&pt=60&stop_id=` + vars["id"], function(data) {
        var body =
          `<center><h1>${decodeURIComponent(vars['name'])}</h1><br/><div id="change"><h4>Refreshing in ${count}s</h4><br/><h6>The current time is ${new Date().toLocaleTimeString()}</h6></div><br/><h6>Enter new location here:</h6><input id="provider-remote" /><br/><button type="button" onclick="getLocation()" class="btn btn-primary">Get Nearest Stop</button><br/></br></center>`
        if (data.departures.length == 0) {
          body += `<center><h4>No buses are coming to this stop within the next hour.</h4></center>`;
        } else {
          body += `<table class='table'><thead><tr><th>Bus Name</th><th>Mins Left</th><th>ETA</th><th>Last Location</th></thead><tbody>`;
          for (i = 0; i < data.departures.length; i++) {
            var current = data.departures[i];
            if (current.expected_mins == 0)
              current.expected_mins = "Arriving Now";
            else {
              current.expected_mins += "m";
            }
            var date = new Date(current.expected.toString());
            var hour = date.getHours() % 12;
            if (hour == 0) hour = 12;
            var minute = date.getMinutes();
            if (minute < 10) {
              minute = "0" + minute
            }
            var seconds = date.getSeconds();
            if (seconds < 10) {
              seconds = "0" + seconds
            }
            body +=
              `<tr style='background-color:#${current.route.route_color};color:#${current.route.route_text_color}'><td style="word-wrap:break-word;"><b>${removeColors(current.headsign)}</b></td><td>${current.expected_mins}</td><td>${hour}:${minute}:${seconds}<td><button type="button" class="btn btn-success" onclick="directToMaps(${current.location.lat},${current.location.lon},'${current.trip.trip_id}','${current.vehicle_id}')">Location</button></td></tr>`;
            //"<div style='color:#" + current.route.route_color +
            //";'>" + current.headsign + current.expected_mins + "</div><br/>";
          }
          body += " </tr></tbody></table>"
        }

        document.body.innerHTML += body;
        setOptions();
      });
    };

    if ("id" in vars) {
      getInfo();
      setInterval(function() {
        location.reload();
      }, 60000);
    } else {
      document.body.innerHTML = `<center><h4>Please provide a valid URL.</h4></center>`
    }

    function directToMaps(lat, long, trip, vehicle) {
      console.log(vehicle);
      //window.open(`https://www.google.com/maps/place/${lat},${long}`,'mywindow');
      if (!document.getElementById("location")) {
        document.body.innerHTML +=
          `<div class="modal fade" id="location">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Current Bus Location</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modalBody">

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>`;
      }
      $("#location").modal("show");
      modalBody = document.getElementById("modalBody");
      if (lat != 0 && long != 0) {
        modalBody.innerHTML =
          `<center><img src="https://maps.googleapis.com/maps/api/staticmap?center=${lat},${long}&zoom=15&size=300x300&maptype=roadmap&markers=color:blue%7Clabel:S%7C${lat},${long}&markers=color:green%7Clabel:G%7C40.711614,-74.012318&markers=color:red%7Clabel:C%7C40.718217,-73.998284&key=${google_api}"></img>`
        dist = calcCrow(stop_lat, stop_long, lat, long).toFixed(2)
        if (dist < .05) {
          modalBody.innerHTML += `<center><br>The bus has arrived.</center>`
          $.getJSON(`https://developer.cumtd.com/api/v2.2/json/getvehicle?key=${cumtd_api}&vehicle_id=` + vehicle, function(data) {
            trip_id = data.vehicles[0].trip.trip_id;
            modalBody.innerHTML += `<center><a href='TripInfo.html?trip_id=${trip}'>View Trip Info</a></center>`
            console.log(`<a href='TripInfo.html?trip_id=${trip}'>View Trip Info</a>`);
          });
        } else {
          modalBody.innerHTML += `<center><br>The bus is ${calcCrow(stop_lat, stop_long, lat, long).toFixed(2)} miles away.</center>`
          console.log(vehicle);
          $.getJSON(`https://developer.cumtd.com/api/v2.2/json/getvehicle?key=${cumtd_api}&vehicle_id=` + vehicle, function(data) {
            prev_stop = data.vehicles[0].previous_stop_id;
            next_stop = data.vehicles[0].next_stop_id;
            $.getJSON(`https://developer.cumtd.com/api/v2.2/json/getstop?key=${cumtd_api}&stop_id=${prev_stop}`, function(data) {
              if (data.stops[0]) {
                modalBody.innerHTML += `<center><br><b>Previous stop:</b>  ${data.stops[0].stop_name}</center>`
                console.log(`<center><br><b>Previous stop:</b>  ${data.stops[0].stop_name}</center>`);
              }
              $.getJSON(`https://developer.cumtd.com/api/v2.2/json/getstop?key=${cumtd_api}&stop_id=${next_stop}`, function(data) { //this is nested because I wanted to avoid the async call
                if (data.stops[0]) {
                  modalBody.innerHTML += `<center><b>Next stop:</b> ${data.stops[0].stop_name}</center>`
                  console.log(`<center><b>Next stop:</b> ${data.stops[0].stop_name}</center>`);
                }
                modalBody.innerHTML += `<center><a href='TripInfo.html?trip_id=${trip}'>View Trip Info</a></center>`
                console.log(`<a href='TripInfo?trip_id=${trip}'>View Trip Info</a>`);
              });
            });

          });
        }
        setOptions();
        //window.open(`https://maps.googleapis.com/maps/api/staticmap?center=${lat},${long}&zoom=16&size=600x600&maptype=roadmap&markers=color:blue%7Clabel:S%7C${lat},${long}&markers=color:green%7Clabel:G%7C40.711614,-74.012318&markers=color:red%7Clabel:C%7C40.718217,-73.998284&key=${google_api}`,
        //  "mywindow", "width=500,height=500");
      }
    }
    //directToMaps(40.098357, -88.214333);

  function showModalBefore() {
    $('#myModal').modal('show');
    document.getElementById("modalBody2").innerHTML = "Loading stops...";
  }
  function getLocation() {
    if (navigator.geolocation) {
      showModalBefore();
      navigator.geolocation.getCurrentPosition(showPosition);
    } else {
      window.alert("We could not get your location.");
    }
  }
  function showPosition(position) {
    console.log("Got position!")
    console.log(position)
    $.getJSON(`https://developer.cumtd.com/api/v2.2/json/getstopsbylatlon?key=${cumtd_api}&pt=60&lat=${position.coords.latitude}&lon=${position.coords.longitude}`, function(data) {
      console.log(data);
      modalBody = document.getElementById("modalBody2");
      modalBody.innerHTML = "";
      for (i = 0; i < 3; i++) {
        redirectURL = `BusTracking.html?id=${data.stops[i].stop_id}&name=${encodeURIComponent(data.stops[i].stop_name)}`;
        modalBody.innerHTML += `<a href=${redirectURL}>${data.stops[i].stop_name} (${(data.stops[i].distance*0.00018939).toFixed(2)} mi.)</a></br>`
        modalBody.innerHTML += ``;
        console.log(data.stops[i]);
      }
    });
  }
  
  function removeColors(str){
    if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      var colors = ["Yellow","hopper","Red","Lavender","Blue","Green","Orange", "Grey","Bronze","Brown","Gold","Ruby","Teal","Silver","Navy","Pink","Raven","Illini"]
      for (var i = 0; i < colors.length; i++) {
        str = str.split(colors[i]).join('');
      }
    }
  return str;
  }
  </script>

</html>
