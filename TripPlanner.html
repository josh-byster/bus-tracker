<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cdn.ravenjs.com/3.23.3/raven.min.js" crossorigin="anonymous"></script>
  <script src="https://npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- JS file -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/easy-autocomplete/1.3.5/jquery.easy-autocomplete.min.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-109186351-1"></script>
  <script src="gtag.js"></script>
  <script type='text/javascript' src='api-keys.js'></script>


  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

  <!-- CSS file -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/easy-autocomplete/1.3.5/easy-autocomplete.min.css">

  <!-- Additional CSS Themes file - not required-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/easy-autocomplete/1.3.5/easy-autocomplete.themes.css">

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <style>
    .table td {
      padding-top: 2rem;
      padding-bottom: 2rem;
      font-size: 20px;
      border-top: none;
      font-family: ' Lato ', sans-serif;
    }

    .itinerary {
      background-color: #2ecc71;
    }
  </style>
  <title>Trip Planner</title>

  <!-- Bootstrap -->

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <
    script src = "https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js" >
  </script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
  <!-- Global site tag (gtag.js) - Google Analytics -->

</head>

<body>
  <!-- Include all compiled plugins (below), or include individual files as needed -->

  <div class='container' style='margin-top:80px;'>
    <center>

    </center>

    <div id='info'></div>

  </div>


  <script>
    var google_api = my_api_keys.GOOGLE_API_KEY;
    var cumtd_api = my_api_keys.CUMTD_API_KEY;
    var vars = {};
    var stop_lat = 0;
    var stop_long = 0;
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m, key, value) {
      vars[key] = value;
    });

    function toTime(d) {
      var date = new Date(d.toString());
      var hour = date.getHours() % 12;
      var ampm = (date.getHours() < 12 ? "AM" : "PM");
      if (hour == 0) hour = 12;
      var minute = date.getMinutes();
      if (minute < 10) {
        minute = "0" + minute;
      }
      var seconds = date.getSeconds();
      if (seconds < 10) {
        seconds = "0" + seconds;
        return `${hour}:${minute+ampm}`;
      }
    }

    function showModal(lat, long, name) {
      if (!document.getElementById("location")) {
        document.body.innerHTML +=
          `<div class="modal fade" id="location">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal_title">Current Bus Location</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modalBody">

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>`;
      }
      $("#location").modal("show");
      modalBody = document.getElementById("modalBody");
      if (lat != 0 && long != 0) {
        modalBody.innerHTML =
          `<center><img src="https://maps.googleapis.com/maps/api/staticmap?center=${lat},${long}&zoom=15&size=300x300&maptype=roadmap&markers=color:blue%7Clabel:S%7C${lat},${long}&markers=color:green%7Clabel:G%7C40.711614,-74.012318&markers=color:red%7Clabel:C%7C40.718217,-73.998284&key=${google_api}"></img>`
        document.getElementById("modal_title").innerHTML = name;
      }
    }

    function toModalLink(begin) {
      var lat = begin.lat;
      var long = begin.lon;
      return `<a href="#" onclick="showModal(${lat},${long},'${begin.name}')">${begin.name}</a>`;
    }

    function getTrips() {
      $.getJSON(
        `https://developer.cumtd.com/api/v2.2/json/getplannedtripsbystops?key=${cumtd_api}&origin_stop_id=${vars['origin']}&destination_stop_id=${vars['destination']}`,
        function(data) {
          if (data.status.msg != "ok")
            document.getElementById('info').innerHTML += data.status.msg;
          else {

            itin = data.itineraries;
            for (i in itin) { //iterates through each of the 3 itineraries

              current_plan = itin[i];
              document.getElementById('info').innerHTML += `<center><div class='itinerary'>Itinerary ${parseInt(i)+1}`;
              document.getElementById('info').innerHTML += `Start time: ${toTime(current_plan.start_time)}<br/>
            Travel time: ${current_plan.travel_time} minutes<br/></br>`;
              for (j in current_plan.legs) {

                current_leg = current_plan.legs[j];
                if (current_leg.type == "Walk") {
                  var walk = current_leg.walk;
                  var begin_time = new Date(walk.begin.time);
                  var end_time = new Date(walk.end.time);
                  var walk_time = (end_time - begin_time) / 1000 / 60;
                  document.getElementById('info').innerHTML +=
                    `At ${toTime(walk.begin.time)}: Walk ${walk.direction} from ${toModalLink(walk.begin)} a distance of ${walk.distance} miles to ${toModalLink(walk.end)}. This should take about ${walk_time} minutes.`;
                  //console.log("WALK!");
                }
                if (current_leg.type == "Service") {
                  var bus_info = current_leg.services[0];
                  var begin_time = new Date(bus_info.begin.time);
                  var end_time = new Date(bus_info.end.time);
                  var ride_time = (end_time - begin_time) / 1000 / 60;
                  document.getElementById('info').innerHTML +=
                    `At ${toTime(bus_info.begin.time)}: Take the <span style='background-color:#${bus_info.route.route_color};color:#${bus_info.route.route_text_color}'>${bus_info.route.route_short_name+bus_info.trip.direction[0]}</span> from ${toModalLink(bus_info.begin)} to ${toModalLink(bus_info.end)}. This should take about ${ride_time} minutes.`;
                }
                document.getElementById('info').innerHTML += "</br>";
              }
              //document.getElementById('info').innerHTML += "</br>End of legs for itinerary</br></br>";
              document.getElementById('info').innerHTML += "</br>";
            }
          }
        });
    }

    getTrips();
    //showModal();
  </script>
  <script type="text/javascript">
    window._urq = window._urq || [];
    _urq.push(['initSite', '96cc2c62-7395-4573-8001-5b852e8d380b']);
    (function() {
      var ur = document.createElement('script');
      ur.type = 'text/javascript';
      ur.async = true;
      ur.src = ('https:' == document.location.protocol ? 'https://cdn.userreport.com/userreport.js' : 'http://cdn.userreport.com/userreport.js');
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ur, s);
    })();
  </script>
</body>

</html>
